# Spring Security

# ì¸ì¦ê³¼ ì¸ê°€ë€?

### ì¸ì¦(Authentication)

 ì‚¬ìš©ìê°€ ìì‹ ì„ ì‹ë³„í•˜ê³  ìì‹ ì´ ì£¼ì¥í•˜ëŠ” ì‚¬ëŒì„ì„ `ì¦ëª…`í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” `ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸, ìƒì²´ ì¸ì‹` ë“±ì˜ ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì¸ì¦ì€ ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” `ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸`í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.

### ì¸ê°€(Authorization)

ì¸ê°€ëŠ” ì¸ì¦ëœ ì‚¬ìš©ìì— ëŒ€í•œ `ì ‘ê·¼ ê¶Œí•œ`ì„ ê´€ë¦¬í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. ì¸ê°€ëŠ” ì‚¬ìš©ìê°€ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, íŠ¹ì • ì‚¬ìš©ìê°€ ì½ê¸°, ì“°ê¸° ë˜ëŠ” ì‹¤í–‰ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ì—¬ í•´ë‹¹ ì‚¬ìš©ìê°€ íŠ¹ì • íŒŒì¼ì´ë‚˜ ë°ì´í„°ë² ì´ìŠ¤ì— `ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ ê²°ì •`í•©ë‹ˆë‹¤.

ìš”ì•½í•˜ë©´, ì¸ì¦ì€ ì‚¬ìš©ìì˜ `ì‹ ì›ì„ í™•ì¸`í•˜ê³  ì¸ê°€ëŠ” ì‚¬ìš©ìì—ê²Œ íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ `ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬`í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.

[ì¸ì¦(Authentication) vs. ì¸ê°€(Authorization)](https://dextto.tistory.com/234)

---

# ì‹¤ì œ êµ¬í˜„

## Token Provider

`jwt.secret`ê³¼, `token-validatiy-in-seconds`ë¥¼ ì´ìš©í•˜ì—¬ ë¹ˆì„ ì£¼ì… ë°›ì€ í›„, `afterPropertiesSet`ì„ êµ¬ì„±í•˜ê¸° ìœ„í•´, `InitializingBean`ì„ ì‚¬ìš©í•œë‹¤. 

- `tokenProvider`ëŠ” í† í°ì„ ìƒì„±í•˜ëŠ” ì¼ì„ í•œë‹¤.
- `token`ì„ ê°€ì§€ê³  `Authentication` ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
    - `key`ë¥¼ ì´ìš©í•´ `claim`ì„ ë¹¼ë‚¸ë‹¤.
    - claim â†’ authority , user ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. ì´ë¥¼ í†µí•´ principal, token, authoritisë¥¼ ë¹¼ë‚´ì„œ `Authentication`ì„ ì €ì¥í•œë‹¤.
    - tokenì„ validate í•œë‹¤.
- ì½”ë“œ
    
    ```java
    @Component
    public class TokenProvider implements InitializingBean {
    
        private final Logger logger = LoggerFactory.getLogger(TokenProvider.class);
        private static final String AUTHORITIES_KEY = "auth";
        private final String secret;
        private final long tokenValidityInMilliseconds;
        private Key key;
    
        public TokenProvider(
            @Value("${jwt.secret}") String secret,
            @Value("${jwt.token-validity-in-seconds}") long tokenValidityInSeconds) {
            this.secret = secret;
            this.tokenValidityInMilliseconds = tokenValidityInSeconds * 1000;
        }
    
        @Override
        public void afterPropertiesSet() {
            byte[] keyBytes = Decoders.BASE64.decode(secret);
            this.key = Keys.hmacShaKeyFor(keyBytes);
        }
    
        public String createToken(Authentication authentication) {
            String authorities = authentication.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.joining(","));
    
            long now = (new Date()).getTime();
            Date validity = new Date(now + this.tokenValidityInMilliseconds);
    
            return Jwts.builder()
                .setSubject(authentication.getName())
                .claim(AUTHORITIES_KEY, authorities)
                .signWith(key, SignatureAlgorithm.HS512)
                .setExpiration(validity)
                .compact();
        }
    
        public Authentication getAuthentication(String token) {
            Claims claims = Jwts
                .parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody();
    
            Collection<? extends GrantedAuthority> authorities =
                Arrays.stream(claims.get(AUTHORITIES_KEY).toString().split(","))
                    .map(SimpleGrantedAuthority::new)
                    .collect(Collectors.toList());
    
            User principal = new User(claims.getSubject(), "", authorities);
    
            return new UsernamePasswordAuthenticationToken(principal, token, authorities);
        }
    
        public boolean validateToken(String token) {
            try {
                Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
                return true;
            } catch (io.jsonwebtoken.security.SecurityException | MalformedJwtException e) {
                logger.info("ì˜ëª»ëœ JWT ì„œëª…ì…ë‹ˆë‹¤.");
            } catch (ExpiredJwtException e) {
                logger.info("ë§Œë£Œëœ JWT í† í°ì…ë‹ˆë‹¤.");
            } catch (UnsupportedJwtException e) {
                logger.info("ì§€ì›ë˜ì§€ ì•ŠëŠ” JWT í† í°ì…ë‹ˆë‹¤.");
            } catch (IllegalArgumentException e) {
                logger.info("JWT í† í°ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
            return false;
        }
    }
    ```
    
    ```java
    jwt:
      header: Authorization
      #HS512 ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— 512bit, ì¦‰ 64byte ì´ìƒì˜ secret keyë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
      #echo 'silvernine-tech-spring-boot-jwt-tutorial-secret-silvernine-tech-spring-boot-jwt-tutorial-secret'|base64
      secret: c2lsdmVybmluZS10ZWNoLXNwcmluZy1ib290LWp3dC10dXRvcmlhbC1zZWNyZXQtc2lsdmVybmluZS10ZWNoLXNwcmluZy1ib290LWp3dC10dXRvcmlhbC1zZWNyZXQK
      token-validity-in-seconds: 86400
    ```
    

<aside>
ğŸ’¡ DB ì„¤ì¹˜ ì´ìŠˆ

</aside>

h2 ê´€ë ¨ ì´ìŠˆ ì˜€ë‹¤. embedded ë””ë¹„ ë³´ë‹¤ëŠ” h2 server dbë¥¼ ì¨ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  ì‹¤ìˆ˜ë¡œ íŒ¨í‚¤ì§€ë¥¼ application ë°–ì—ë‹¤ í–ˆë”ë‹ˆ, beanì„ ëª»ê°€ì ¸ì™€ì„œ, entity ë¥¼ ë“±ë¡ì„ ëª»í•´ì„œ dbë“±ë¡ì´ ì•ˆë˜ì—ˆë‹¤.. 

```java
url:  jdbc:h2:tcp://localhost/~/test
    driver-class-name: org.h2.Driver
```

```java
sql:
    init:
      mode: always
```

ì´ëŠ” ì‹¤í–‰ ì‹œ, `data.sql`ì„ ìë™ìœ¼ë¡œ ì½ì„ ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤. 

## JwtFilter

tokenProviderë¥¼ ì£¼ì… ë°›ëŠ”ë‹¤. ì²˜ìŒ ì§„ì…í•  ë•Œ matchingì„ í†µí•´ Filterì— ë“¤ì–´ ì˜¤ë©´,

- Request ì™€ Responseë¥¼ ë°›ê²Œ ëœë‹¤.
- jwt ë¥¼ ì•Œê²Œ ë˜ë©´ ì´ë¥¼ `tokenProvider`ë¥¼ í†µí•´ ê²€ì¦í•œë‹¤.
- ê²€ì¦í•´ì„œ ê´œì°®ë‹¤ë©´, Authenticationì— ì €ì¥ì„ í•˜ê²Œ ë˜ê³ , ì´ëŠ” `SecurityContext`ì— ì €ì¥í•  ìˆ˜ ìˆë‹¤.
- ê·¸ë¦¬ê³  `filterChain.doFilter`ì— ë„˜ê¸°ê²Œ ëœë‹¤.
- ì½”ë“œ
    
    ```java
    public class JwtFilter extends GenericFilterBean {
    
       private static final Logger logger = LoggerFactory.getLogger(JwtFilter.class);
       public static final String AUTHORIZATION_HEADER = "Authorization";
       private final TokenProvider tokenProvider;
       public JwtFilter(TokenProvider tokenProvider) {
          this.tokenProvider = tokenProvider;
       }
    
       @Override
       public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
          HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;
          String jwt = resolveToken(httpServletRequest);
          String requestURI = httpServletRequest.getRequestURI();
    
          if (StringUtils.hasText(jwt) && tokenProvider.validateToken(jwt)) {
             Authentication authentication = tokenProvider.getAuthentication(jwt);
             SecurityContextHolder.getContext().setAuthentication(authentication);
             logger.debug("Security Contextì— '{}' ì¸ì¦ ì •ë³´ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤, uri: {}", authentication.getName(), requestURI);
          } else {
             logger.debug("ìœ íš¨í•œ JWT í† í°ì´ ì—†ìŠµë‹ˆë‹¤, uri: {}", requestURI);
          }
    
          filterChain.doFilter(servletRequest, servletResponse);
       }
    
       private String resolveToken(HttpServletRequest request) {
          String bearerToken = request.getHeader(AUTHORIZATION_HEADER);
    
          if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
             return bearerToken.substring(7);
          }
    
          return null;
       }
    }
    ```
    

## JwtConfig

- `SecurityConfigurerAdapter<DefaultSecurityFilterChain, HttpSecurity>` ë¥¼ ìƒì† ë°›ëŠ”ë‹¤.
- JwtFilterë¥¼ filterì— ê±¸ì–´ì¤€ë‹¤.
- ì½”ë“œ
    
    ```java
    public class JwtConfig extends SecurityConfigurerAdapter<DefaultSecurityFilterChain, HttpSecurity> {
    
        private final TokenProvider tokenProvider;
    
        public JwtConfig(TokenProvider tokenProvider) {
            this.tokenProvider = tokenProvider;
        }
    
        @Override
        public void configure(HttpSecurity builder) throws Exception {
            super.configure(builder);
            JwtFilter jwtFilter = new JwtFilter(tokenProvider);
            builder.addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
        }
    }
    ```
    

## JwtAuthenticationEntryPoint

- `AuthenticationEntryPoint` ë¥¼ Implement í•œë‹¤.
- ìœ íš¨í•œ `ìê²©ì¦ëª…`ì„ ì œê³µí•˜ì§€ ì•Šê³  ì ‘ê·¼í•˜ë ¤ í• ë•Œ `401` ì—ëŸ¬ë¥¼ ë„ìš´ë‹¤.
- ì½”ë“œ
    
    ```java
    package com.example.springsecurity.jwt;
    
    import org.springframework.security.core.AuthenticationException;
    import org.springframework.security.web.AuthenticationEntryPoint;
    import org.springframework.stereotype.Component;
    
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import java.io.IOException;
    
    @Component
    public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint {
       @Override
       public void commence(HttpServletRequest request,
                            HttpServletResponse response,
                            AuthenticationException authException) throws IOException {
          // ìœ íš¨í•œ ìê²©ì¦ëª…ì„ ì œê³µí•˜ì§€ ì•Šê³  ì ‘ê·¼í•˜ë ¤ í• ë•Œ 401
          response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
       }
    }
    ```
    

## JwtAccessDeniedHandler

- `AccessDeniedHandler` ë¥¼ implements í•œë‹¤.
- í•„ìš”í•œ ê¶Œí•œì´ ì—†ì´ ì ‘ê·¼í•˜ë ¤ í• ë•Œ `403` ì—ëŸ¬ë¥¼ ë„ìš´ë‹¤.
- ì½”ë“œ
    
    ```java
    
    @Component
    public class JwtAccessDeniedHandler implements AccessDeniedHandler {
       @Override
       public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException {
          response.sendError(HttpServletResponse.SC_FORBIDDEN);
       }
    }
    ```
    

## SecurityConfig

- ì¡°ê¸ˆ ë§ì´ ì–´ë µë‹¤.
- TokenProvider , JwtAuthenticationEntryPoint,  JwtAccessDeniedHandler ë¥¼ ì£¼ì… ë°›ëŠ”ë‹¤.
- Bean ìœ¼ë¡œ  PasswordEncoderë¥¼ ë“±ë¡í•œë‹¤.
- csrf disable, h2 console ì„¤ì • ì¶”ê°€, StatleLess ì„¤ì •, USER ê¶Œí•œ ê°€ì§„ ì‚¬ëŒë§Œ! ì£¼ë„ë¡ í•œë‹¤.
- ì½”ë“œ
    
    ```java
    @EnableWebSecurity
    @EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)
    public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
        private final TokenProvider tokenProvider;
        private final JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
        private final JwtAccessDeniedHandler jwtAccessDeniedHandler;
    
        public SecurityConfig(TokenProvider tokenProvider,
                       JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint,
                       JwtAccessDeniedHandler jwtAccessDeniedHandler) {
            this.tokenProvider = tokenProvider;
            this.jwtAuthenticationEntryPoint = jwtAuthenticationEntryPoint;
            this.jwtAccessDeniedHandler = jwtAccessDeniedHandler;
        }
        @Bean
        public PasswordEncoder BCryptPasswordEncoder() {
            return new BCryptPasswordEncoder();
        }
    
        @Override
        protected void configure(HttpSecurity http) throws Exception {
    
            http
                // tokenì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ê¸° ë•Œë¬¸ì— csrfë¥¼ disableí•©ë‹ˆë‹¤.
                .csrf(csrf -> csrf.disable())
                .exceptionHandling()
                .authenticationEntryPoint(jwtAuthenticationEntryPoint)
                .accessDeniedHandler(jwtAccessDeniedHandler)
                .and()
                    // h2-consoleì„ ìœ„í•œ ì„¤ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                    .headers()
                    .frameOptions()
                    .sameOrigin()
                .and()
                    // ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— STATELESSë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
                    .sessionManagement()
                    .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
                .and()
                .authorizeRequests()
                    // íšŒì› ê´€ë¦¬ ì²˜ë¦¬ API ì „ë¶€ë¥¼ USER ê¶Œí•œì„ ê°€ì§„ ì‚¬ëŒë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
                    .antMatchers("/api/hello").permitAll()
                    .antMatchers("/api/authenticate").permitAll()
                    .antMatchers("/api/signup").permitAll()
                    .antMatchers("/api/admin").hasRole("ADMIN")
                    .anyRequest().authenticated()
                .and()
                .apply(new JwtConfig(tokenProvider));
    
        }
    
        @Override
        public void configure(WebSecurity web) throws Exception {
            super.configure(web);
            web
                .ignoring().antMatchers("/h2-console/**", "/favicon.ico");
        }
    }
    ```
    

## MemberRepository

- ëª¨ë“  ê¶Œí•œì„ í•¨ê»˜ ëŒì–´ì˜¤ëŠ” memberRepository ì´ë‹¤.
- ì½”ë“œ
    
    ```java
    public interface MemberRepository extends JpaRepository<Member, Long> {
    
        @EntityGraph(attributePaths = "authorities")
        Optional<Member> findOneWithAuthoritiesByMemberName(String memberName);
    
    }
    ```
    

## CustomUserDetailsService

- CustomUserDetailsService ëŠ” `UserDetailService`ë¥¼ implements í•œë‹¤.
- `loadUserByUsername` í•¨ìˆ˜ë¥¼ ì˜¤ë²„ë¼ì´ë“œ í•˜ëŠ”ë°, memberRepositoryì—ì„œ í•´ë‹¹ UserNameì„ ì°¾ê³  Userë¥¼ ë§Œë“¤ì–´ `UserDetails`ë¡œ ë°˜í™˜í•œë‹¤.
- ì½”ë“œ
    
    ```java
    
    @Component("userDetailsService")
    public class CustomUserDetailsService implements UserDetailsService
    {
        private final MemberRepository memberRepository;
    
        public CustomUserDetailsService(MemberRepository memberRepository) {
            this.memberRepository = memberRepository;
        }
    
        @Override
        public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
            return memberRepository.findOneWithAuthoritiesByMemberName(username)
                    .map(member -> createUser(username, member))
                    .orElseThrow(() -> new UsernameNotFoundException(username + " -> ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
    
        private User createUser(String username, Member member) {
    
            if (!member.isActivated()) {
                throw new RuntimeException(username + " -> í™œì„±í™”ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
            List<GrantedAuthority> grantedAuthorities = member.getAuthorities().stream()
                    .map(authority -> new SimpleGrantedAuthority(authority.getAuthorityName()))
                    .collect(Collectors.toList());
            return new User(member.getMemberName(),
                    member.getPassword(),
                    grantedAuthorities);
        }
    }
    ```
    

## AuthController

- authenticate ìê²©ì„ ìœ„ì„í•˜ëŠ” API ì´ë‹¤.
- `authenticate`ë¡œ ìš”ì²­í•˜ë©´, `jwt`ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.
- loginDtoëŠ” nickname, username, passwordê°€ ìˆëŠ”ë°, ì´ë¥¼ í†µí•´ `authenticationToken`ì„ ë§Œë“¤ê³ , `authentication`ì„ buildí•œë‹¤. ê·¸ë¦¬ê³ , contextì— í•´ë‹¹ ê¶Œí•œì„ ì €ì¥í•œë‹¤.
- ê·¸ë¦¬ê³  jwtë¥¼ ë°˜í™˜í•œë‹¤.
- ì½”ë“œ
    
    ```java
    
    @RestController
    @RequestMapping("/api")
    public class AuthController {
        private final TokenProvider tokenProvider;
        private final AuthenticationManagerBuilder authenticationManagerBuilder;
    
        public AuthController(TokenProvider tokenProvider, AuthenticationManagerBuilder authenticationManagerBuilder) {
            this.tokenProvider = tokenProvider;
            this.authenticationManagerBuilder = authenticationManagerBuilder;
        }
    
        @PostMapping("/authenticate")
        public ResponseEntity<TokenDto> authorize(@Valid @RequestBody  LoginDto loginDto) {
    
            UsernamePasswordAuthenticationToken authenticationToken = new UsernamePasswordAuthenticationToken(loginDto.getMemberName(), loginDto.getPassword());
    
            Authentication authentication = authenticationManagerBuilder.getObject().authenticate(authenticationToken);
            SecurityContextHolder.getContext().setAuthentication(authentication);
    
            String jwt = tokenProvider.createToken(authentication);
            HttpHeaders httpHeaders = new HttpHeaders();
            httpHeaders.add(JwtFilter.AUTHORIZATION_HEADER, "Bearer " + jwt);
    
            return new ResponseEntity<>(new TokenDto(jwt), httpHeaders, HttpStatus.OK);
        }
    }
    ```
    

## SecurityUtil

- `SecurityContext` ë¥¼ í†µí•´ í˜„ì¬ usernameì„ êº¼ë‚¼ ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” ìœ í‹¸ì„± í´ë˜ìŠ¤ì´ë‹¤.
- `Authentication` ì—ì„œ `Principal`ì„ êº¼ë‚´ê³ ,  `UserDetails` ë¼ë©´ `getUsername`, `String`ì´ë¼ë©´ ê·¸ ìì²´ë¡œ `username`ì´ë‹¤.
- ì½”ë“œ
    
    ```java
    
    @NoArgsConstructor
    public class SecurityUtil {
        private static final Logger logger = LoggerFactory.getLogger(SecurityUtil.class);
    
        public static Optional<String> getCurrentUsername() {
            Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
            if (authentication == null) {
                logger.debug("authentication: {}", authentication);
                return Optional.empty();
            }
            String username = null;
            if (authentication.getPrincipal() instanceof UserDetails) {
                UserDetails springSecurityUser = (UserDetails) authentication.getPrincipal();
                username = springSecurityUser.getUsername();
            } else if (authentication.getPrincipal() instanceof String) {
                username = (String) authentication.getPrincipal();
            }
            logger.debug("username: {}", username);
            return Optional.ofNullable(username);
        }
    }
    ```
    

# UserService

- signUp, userì •ë³´, ê·¸ë¦¬ê³  userì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” adminê¶Œí•œì¸ API ê°€ ì¡´ì¬í•œë‹¤.
- ì½”ë“œ
    
    ```java
    
    @Service
    @Transactional(readOnly = true)
    public class UserService {
    
        private final MemberRepository memberRepository;
        private final PasswordEncoder passwordEncoder;
    
        public UserService(MemberRepository memberRepository, PasswordEncoder passwordEncoder) {
            this.memberRepository = memberRepository;
            this.passwordEncoder = passwordEncoder;
        }
    
        @Transactional
        public Member signup(MemberDto userDto) {
            if (memberRepository.findOneWithAuthoritiesByMemberName(userDto.getMemberName()).orElse(null) != null) {
                throw new RuntimeException("ì´ë¯¸ ê°€ì…ë˜ì–´ ìˆëŠ” ìœ ì €ì…ë‹ˆë‹¤.");
            }
    
            Authority authority = Authority.builder()
                .authorityName("ROLE_USER")
                .build();
    
            Member member = Member.builder()
                .memberName(userDto.getMemberName())
                .password(passwordEncoder.encode(userDto.getPassword()))
                .nickname(userDto.getNickname())
                .authorities(Collections.singleton(authority))
                .activated(true)
                .build();
    
            return memberRepository.save(member);
        }
    
        @Transactional(readOnly = true)
        public Member getUserWithAuthorities(String memberName) {
            return memberRepository.findOneWithAuthoritiesByMemberName(memberName)
                .orElseThrow(() -> new RuntimeException("í•´ë‹¹ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤."));
        }
    
        @Transactional(readOnly = true)
        public Member getUserWithAuthorities() {
            return SecurityUtil.getCurrentUsername()
                .flatMap(memberRepository::findOneWithAuthoritiesByMemberName)
                .orElseThrow(() -> new RuntimeException("ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
        }
    }
    ```
    

---

# Chore

## Application.yml

- ì½”ë“œ
    
    ```java
    spring:
    
      h2:
        console:
          enabled: true
    
      datasource:
        url:  jdbc:h2:tcp://localhost/~/test
        driver-class-name: org.h2.Driver
        username: sa
        password:
      jpa:
        database-platform: org.hibernate.dialect.H2Dialect
        hibernate:
          ddl-auto: create-drop
        properties:
          hibernate:
            format_sql: true
            show_sql: true
    
        defer-datasource-initialization: true
      sql:
        init:
          mode: always
    
    jwt:
      header: Authorization
      #HS512 ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— 512bit, ì¦‰ 64byte ì´ìƒì˜ secret keyë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
      #echo 'silvernine-tech-spring-boot-jwt-tutorial-secret-silvernine-tech-spring-boot-jwt-tutorial-secret'|base64
      secret: c2lsdmVybmluZS10ZWNoLXNwcmluZy1ib290LWp3dC10dXRvcmlhbC1zZWNyZXQtc2lsdmVybmluZS10ZWNoLXNwcmluZy1ib290LWp3dC10dXRvcmlhbC1zZWNyZXQK
      token-validity-in-seconds: 86400
    
    logging:
      level:
        me.silvernine: DEBUG
    ```
    

## build.gradle

- ì½”ë“œ
    
    ```java
    plugins {
        id 'java'
        id 'org.springframework.boot' version '2.7.14'
        id 'io.spring.dependency-management' version '1.0.15.RELEASE'
    }
    
    group = 'com.example'
    version = '0.0.1-SNAPSHOT'
    
    java {
        sourceCompatibility = '11'
    }
    
    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }
    
    repositories {
        mavenCentral()
    }
    
    dependencies {
        runtimeOnly("com.h2database:h2")
        implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
        implementation 'org.springframework.boot:spring-boot-starter-security'
        implementation 'org.springframework.boot:spring-boot-starter-validation'
        implementation 'org.springframework.boot:spring-boot-starter-web'
        compileOnly 'org.projectlombok:lombok'
        developmentOnly 'org.springframework.boot:spring-boot-devtools'
        annotationProcessor 'org.projectlombok:lombok'
        testImplementation 'org.springframework.boot:spring-boot-starter-test'
        testImplementation 'org.springframework.security:spring-security-test'
        implementation group: 'io.jsonwebtoken', name: 'jjwt-api', version: '0.11.5'
        runtimeOnly group: 'io.jsonwebtoken', name: 'jjwt-impl', version: '0.11.5'
        runtimeOnly group: 'io.jsonwebtoken', name: 'jjwt-jackson', version: '0.11.5'
    }
    
    tasks.named('test') {
        useJUnitPlatform()
    }
    ```
